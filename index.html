<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Genie Lamp</title>
  <style>
    :root{
      --sand1:#f7edd7;
      --sand2:#f2dcc0;
      --sand3:#e6c79f;
      --sand4:#d6aa74;

      --text:#2a1f12;
      --muted:rgba(42,31,18,.70);

      --card:rgba(255,255,255,.58);
      --stroke:rgba(42,31,18,.10);
      --shadow:rgba(40,25,10,.26);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      overflow:hidden;
      touch-action:none;

      background:
        radial-gradient(900px 700px at 50% 16%, rgba(255,255,255,.62), transparent 62%),
        radial-gradient(1000px 800px at 22% 72%, rgba(214,170,116,.35), transparent 66%),
        radial-gradient(900px 700px at 80% 78%, rgba(230,199,159,.42), transparent 62%),
        linear-gradient(180deg, var(--sand1) 0%, var(--sand2) 35%, var(--sand3) 70%, var(--sand4) 100%);
    }

    /* Dunes only */
    body::before{
      content:"";
      position:fixed;
      inset:-2px;
      pointer-events:none;
      opacity:.72;
      background-repeat:no-repeat;
      background-position: 50% 100%;
      background-size: cover;
      mix-blend-mode: multiply;
      filter: drop-shadow(0 12px 16px rgba(40,25,10,.10));
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='800' viewBox='0 0 1200 800'%3E%3Cdefs%3E%3CradialGradient id='sun' cx='50%25' cy='24%25' r='40%25'%3E%3Cstop offset='0%25' stop-color='%23fff3d8' stop-opacity='1'/%3E%3Cstop offset='60%25' stop-color='%23fff3d8' stop-opacity='.35'/%3E%3Cstop offset='100%25' stop-color='%23fff3d8' stop-opacity='0'/%3E%3C/radialGradient%3E%3ClinearGradient id='d1' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%23e9caa4' stop-opacity='.65'/%3E%3Cstop offset='100%25' stop-color='%23d7aa76' stop-opacity='.88'/%3E%3C/linearGradient%3E%3ClinearGradient id='d2' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%23f0d7b8' stop-opacity='.55'/%3E%3Cstop offset='100%25' stop-color='%23e2bf95' stop-opacity='.75'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='1200' height='800' fill='none'/%3E%3Ccircle cx='600' cy='170' r='220' fill='url(%23sun)'/%3E%3Cpath d='M0 610 C140 540, 320 560, 470 590 C640 625, 780 520, 930 560 C1060 595, 1120 575, 1200 540 L1200 800 L0 800 Z' fill='url(%23d2)'/%3E%3Cpath d='M0 670 C120 610, 280 640, 420 675 C590 720, 770 615, 920 655 C1040 690, 1110 675, 1200 635 L1200 800 L0 800 Z' fill='url(%23d1)'/%3E%3C/svg%3E");
    }

    /* subtle grain */
    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image: radial-gradient(rgba(0,0,0,.06) 1px, transparent 1px);
      background-size: 3px 3px;
      opacity:.14;
      mix-blend-mode: multiply;
    }

    .safe{
      position:relative;
      height:100svh;
      width:100vw;
      padding:
        calc(env(safe-area-inset-top) + 10px)
        calc(env(safe-area-inset-right) + 10px)
        calc(env(safe-area-inset-bottom) + 10px)
        calc(env(safe-area-inset-left) + 10px);
    }

    /* prettier title */
    .title{
      position:absolute;
      top: calc(env(safe-area-inset-top) + 10px);
      left:50%;
      transform:translateX(-50%);
      width:min(92vw, 560px);
      text-align:center;
      z-index: 6;
      transition: opacity .35s ease, transform .35s ease;
    }
    .title .chip{
      display:inline-block;
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(255,255,255,.45);
      border: 1px solid rgba(42,31,18,.10);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 12px 28px rgba(40,25,10,.12);
    }
    .title .text{
      display:inline-block;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .18em;
      font-size: clamp(16px, 4.6vw, 22px);
      line-height:1.1;
      color: transparent;
      background: linear-gradient(180deg, #6a3e18, #2a1f12);
      -webkit-background-clip: text;
      background-clip: text;
      text-shadow: 0 10px 20px rgba(255,255,255,.25);
    }
    .title .spark{
      display:inline-block;
      margin: 0 8px;
      font-size: 14px;
      opacity:.75;
      color: #6a3e18;
      vertical-align: middle;
    }

    .stage{ position:absolute; inset:0; }

    .lamp{
      position:absolute;
      display:grid;
      place-items:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      filter: drop-shadow(0 18px 22px var(--shadow));
      transition: opacity .35s ease, transform .45s ease, filter .45s ease;
      z-index: 2;
    }
    .lamp button{
      all:unset;
      display:grid;
      place-items:center;
      width:100%;
      height:100%;
      cursor:pointer;
      border-radius: 24px;
      touch-action:none;
    }
    .lamp img{
      width:100%;
      height:100%;
      object-fit: contain;
      display:block;
      pointer-events:none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.20));
    }

    /* BIG lamps */
    .corner{
      width: 36vw;
      max-width: 210px;
      min-width: 140px;
      aspect-ratio: 1 / 1;
      opacity:.99;
    }
    .center{
      width: 60vw;
      max-width: 360px;
      min-width: 230px;
      aspect-ratio: 1 / 1;
      left:50%;
      top:56%;
      transform: translate(-50%, -50%);
      z-index: 3;
    }

    .tl{ left: 6px; top: calc(env(safe-area-inset-top) + 74px); }
    .tr{ right: 6px; top: calc(env(safe-area-inset-top) + 74px); }
    .bl{ left: 6px; bottom: 6px; }
    .br{ right: 6px; bottom: 6px; }

    /* Glow around center lamp */
    .center::before{
      content:"";
      position:absolute;
      inset:-16%;
      border-radius: 999px;
      background:
        radial-gradient(closest-side at 38% 30%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(closest-side at 66% 66%, rgba(246,198,77,.38), transparent 60%),
        radial-gradient(closest-side at 30% 70%, rgba(255,255,255,.22), transparent 60%);
      opacity:.55;
      filter: blur(1px);
      pointer-events:none;
      z-index:-1;
      animation: glow 2.6s ease-in-out infinite;
    }
    @keyframes glow{
      0%,100%{ transform: scale(1); opacity:.48; }
      50%{ transform: scale(1.05); opacity:.62; }
    }

    .pulse{
      animation: pulse 1.35s ease-in-out infinite;
      filter: drop-shadow(0 18px 26px rgba(40,25,10,.32)) drop-shadow(0 0 22px rgba(246,198,77,.36));
    }
    @keyframes pulse{
      0%,100%{ transform: translate(-50%, -50%) scale(1); }
      50%{ transform: translate(-50%, -50%) scale(1.06); }
    }

    /* Ambient dust */
    .ambient{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index: 4;
      overflow:hidden;
      transition: opacity .25s ease;
    }
    .dust{
      position:absolute;
      width:6px;
      height:6px;
      border-radius:999px;
      background: rgba(255,255,255,.55);
      box-shadow: 0 0 14px rgba(255,255,255,.45);
      opacity:0;
      transform: translate3d(0,0,0);
      animation: floatUp linear infinite;
    }
    @keyframes floatUp{
      0%   { transform: translate3d(0, 24px, 0) scale(.75); opacity:0; }
      10%  { opacity:.55; }
      70%  { opacity:.35; }
      100% { transform: translate3d(0, -120px, 0) scale(1.05); opacity:0; }
    }

    /* Focus modes: no text */
    body.mode-rub .title,
    body.mode-win .title{
      opacity:0;
      transform: translateX(-50%) translateY(-12px);
      pointer-events:none;
    }
    body.mode-rub .corner,
    body.mode-win .corner{
      opacity:0;
      transform: scale(.85);
      pointer-events:none;
    }

    body.mode-rub .center{
      animation:none;
      transform: translate(-50%, -50%) scale(1.62);
      filter: drop-shadow(0 30px 46px rgba(40,25,10,.35)) drop-shadow(0 0 34px rgba(246,198,77,.40));
    }
    body.mode-win .center{
      animation:none;
      transform: translate(-50%, -50%) scale(1.55);
      filter: drop-shadow(0 28px 44px rgba(40,25,10,.34)) drop-shadow(0 0 34px rgba(246,198,77,.38));
    }

    body.mode-rub .ambient{ opacity:.22; }
    body.mode-win .ambient{ opacity:0; }

    body.mode-rub .center.rub-active{
      animation: rubWiggle .18s ease-in-out infinite alternate;
    }
    @keyframes rubWiggle{
      from { transform: translate(-50%, -50%) scale(1.62) rotate(-1.2deg); }
      to   { transform: translate(-50%, -50%) scale(1.62) rotate( 1.2deg); }
    }

    /* Prize: lower than middle */
    .reward{
      position:absolute;
      left:50%;
      top:68%;
      transform: translate(-50%, -50%);
      width: min(68vw, 340px);
      max-width: 380px;
      pointer-events:none;
      opacity:0;
      filter: drop-shadow(0 24px 34px rgba(40,25,10,.30));
      z-index: 9;
    }
    .reward img{
      width:100%;
      height:auto;
      display:block;
      transform-origin: 50% 80%;
      border-radius: 16px;
      background: rgba(255,255,255,.35);
      border: 1px solid rgba(42,31,18,.08);
    }
    .reward.show{
      animation: rise .55s cubic-bezier(.18,.9,.22,1) forwards;
      opacity:1;
    }
    @keyframes rise{
      0%   { transform: translate(-50%, -10%) scale(.25) rotate(-8deg); opacity:0; }
      100% { transform: translate(-50%, -58%) scale(1) rotate(0deg); opacity:1; }
    }
    .reward.float{ animation: floaty 2.6s ease-in-out infinite; }
    @keyframes floaty{
      0%,100%{ transform: translate(-50%, -58%) scale(1) rotate(0deg); }
      50%{ transform: translate(-50%, -62%) scale(1.02) rotate(1.1deg); }
    }

    /* Form appears after win (but only after delay) */
    .formCard{
      position:absolute;
      left:50%;
      bottom: calc(env(safe-area-inset-bottom) + 12px);
      transform: translateX(-50%) translateY(10px);
      width: min(92vw, 520px);
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 44px rgba(40,25,10,.20);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      opacity:0;
      pointer-events:none;
      transition: opacity .28s ease, transform .28s ease;
      z-index: 10;
    }
    .formCard.reveal{
      opacity:1;
      pointer-events:auto;
      transform: translateX(-50%) translateY(0);
    }

    .stack{ display:grid; gap:10px; }

    .field{
      width:100%;
      appearance:none;
      border: 1px solid rgba(42,31,18,.14);
      background: rgba(255,255,255,.70);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 14px;
      font-size: 15px;
      font-weight:700;
      outline:none;
    }
    .field::placeholder{ color: rgba(42,31,18,.55); font-weight:700; }

    .btn{
      appearance:none;
      border: 1px solid rgba(42,31,18,.14);
      background: rgba(255,255,255,.65);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 14px;
      font-weight:900;
      font-size: 14px;
      cursor:pointer;
      box-shadow: 0 12px 26px rgba(40,25,10,.14);
    }
    .btn.primary{
      border-color: rgba(246,198,77,.60);
      background: rgba(246,198,77,.30);
    }
    .btn:active{ transform: translateY(1px); }

    .shake{ animation: shake .22s ease-in-out 0s 2; }
    @keyframes shake{
      0%{ transform: translateX(-50%) translateY(0); }
      25%{ transform: translateX(calc(-50% - 6px)) translateY(0); }
      50%{ transform: translateX(calc(-50% + 6px)) translateY(0); }
      75%{ transform: translateX(calc(-50% - 4px)) translateY(0); }
      100%{ transform: translateX(-50%) translateY(0); }
    }

    /* Fireworks canvas */
    canvas#fx{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
      opacity:0;
      transition: opacity .3s ease;
      z-index: 5;
    }
    body.mode-win canvas#fx{ opacity:1; }

    /* warm dim while focused */
    body.mode-rub::before,
    body.mode-win::before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(900px 600px at 50% 55%, rgba(255,255,255,.05), rgba(40,25,10,.20));
      pointer-events:none;
      opacity:.72;
      z-index: 1;
    }

    /* Fullscreen checkmark overlay */
    .successOverlay{
      position:fixed;
      inset:0;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      opacity:0;
      pointer-events:none;
      transition: opacity .22s ease;
      z-index: 100;
    }
    .successOverlay.show{
      opacity:1;
      pointer-events:auto;
    }
    .successOverlay .badge{
      width: min(78vw, 320px);
      aspect-ratio: 1/1;
      border-radius: 999px;
      background: rgba(246,198,77,.22);
      border: 2px solid rgba(106,62,24,.20);
      display:grid;
      place-items:center;
      box-shadow: 0 30px 80px rgba(40,25,10,.18);
    }
    .successOverlay .check{
      font-size: min(46vw, 220px);
      line-height: 1;
      font-weight: 1000;
      color: #2a1f12;
      transform: translateY(-2%);
      text-shadow: 0 14px 30px rgba(40,25,10,.12);
    }

    @media (max-height: 700px){
      .tl,.tr{ top: calc(env(safe-area-inset-top) + 88px); }
      .center{ top:58%; }
      .reward{ top:70%; }
    }
  </style>
</head>

<body class="mode-choose">
  <div class="safe">
    <div class="title" id="title">
      <span class="chip">
        <span class="spark">✦</span><span class="text">What will you choose?</span><span class="spark">✦</span>
      </span>
    </div>

    <div class="ambient" id="ambient" aria-hidden="true"></div>

    <canvas id="fx"></canvas>

    <div class="stage" id="stage">
      <!-- Corner lamps (silver) -->
      <div class="lamp corner tl" aria-hidden="true">
        <button tabindex="-1" aria-hidden="true">
          <img alt="Silver genie lamp" src="https://i.postimg.cc/8CPx8fsy/4b0be5b12591e78dec8c6f48ff961c4f-removebg-preview.png">
        </button>
      </div>

      <div class="lamp corner tr" aria-hidden="true">
        <button tabindex="-1" aria-hidden="true">
          <img alt="Silver genie lamp" src="https://i.postimg.cc/8CPx8fsy/4b0be5b12591e78dec8c6f48ff961c4f-removebg-preview.png">
        </button>
      </div>

      <div class="lamp corner bl" aria-hidden="true">
        <button tabindex="-1" aria-hidden="true">
          <img alt="Silver genie lamp" src="https://i.postimg.cc/8CPx8fsy/4b0be5b12591e78dec8c6f48ff961c4f-removebg-preview.png">
        </button>
      </div>

      <div class="lamp corner br" aria-hidden="true">
        <button tabindex="-1" aria-hidden="true">
          <img alt="Silver genie lamp" src="https://i.postimg.cc/8CPx8fsy/4b0be5b12591e78dec8c6f48ff961c4f-removebg-preview.png">
        </button>
      </div>

      <!-- Center lamp (gold) -->
      <div class="lamp center pulse" id="centerLamp" aria-label="Golden genie lamp">
        <button id="centerBtn" aria-label="Golden genie lamp. Tap to focus, then rub to summon a prize.">
          <img alt="Golden genie lamp" src="https://i.postimg.cc/RhnR547x/67db9b3ee05eecd742c46f0e928d8b6b-removebg-preview.png">
        </button>
      </div>

      <!-- Prize -->
      <div class="reward" id="reward" aria-hidden="true">
        <img id="rewardImg" alt="Prize" />
      </div>

      <!-- Form (appears after 1–2s delay) -->
      <div class="formCard" id="formCard" aria-hidden="true">
        <form id="leadForm" class="stack">
          <input class="field" id="nameField" name="name" autocomplete="name" placeholder="Name" aria-label="Name" required>
          <input class="field" id="phoneField" name="phone" type="tel" inputmode="tel" autocomplete="tel"
                 placeholder="Phone number" aria-label="Phone number" required>
          <button class="btn primary" type="submit">Get insights</button>
          <button class="btn" type="button" id="backBtn">Back</button>
        </form>
      </div>

      <!-- Fullscreen checkmark -->
      <div class="successOverlay" id="successOverlay" aria-hidden="true">
        <div class="badge">
          <div class="check">✓</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const PRIZES = [
      "https://i.postimg.cc/dQmPgFVH/62817ed0e5cd909ade3ad022d67d00c6-removebg-preview.png",
      "https://i.postimg.cc/NFGNWWNh/af1d6e44d94ddb8d5543a3ebc182b61c-removebg-preview.png",
      "https://i.postimg.cc/nrw1NM9t/7e560478f068da59a3ab5ca8b82cbe79-removebg-preview.png"
    ];

    const body        = document.body;
    const ambient     = document.getElementById("ambient");
    const centerLamp  = document.getElementById("centerLamp");
    const centerBtn   = document.getElementById("centerBtn");

    const rewardWrap  = document.getElementById("reward");
    const rewardImg   = document.getElementById("rewardImg");

    const formCard    = document.getElementById("formCard");
    const leadForm    = document.getElementById("leadForm");
    const nameField   = document.getElementById("nameField");
    const phoneField  = document.getElementById("phoneField");
    const backBtn     = document.getElementById("backBtn");

    const successOverlay = document.getElementById("successOverlay");

    const fxCanvas    = document.getElementById("fx");
    const ctx         = fxCanvas.getContext("2d");

    // timers
    let revealTimer = null;
    let successTimer = null;

    // ---- Dust ----
    function makeDust(){
      ambient.innerHTML = "";
      const count = 16;
      for (let i=0;i<count;i++){
        const d = document.createElement("span");
        d.className = "dust";
        const x = Math.random() * 100;
        const y = 40 + Math.random() * 60;
        const s = 4 + Math.random() * 6;
        const dur = 6 + Math.random() * 10;
        const delay = Math.random() * dur;

        d.style.left = x + "vw";
        d.style.top = y + "vh";
        d.style.width = s + "px";
        d.style.height = s + "px";
        d.style.animationDuration = dur + "s";
        d.style.animationDelay = (-delay) + "s";
        ambient.appendChild(d);
      }
    }

    // ---- Canvas resize ----
    function resizeCanvas(){
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      fxCanvas.width  = Math.floor(fxCanvas.clientWidth * dpr);
      fxCanvas.height = Math.floor(fxCanvas.clientHeight * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener("resize", resizeCanvas, {passive:true});
    resizeCanvas();

    // ---- Modes ----
    let mode = "choose"; // choose -> rub -> win
    let rubbing = false;
    let lastX = 0, lastY = 0;
    let rubDistance = 0;
    let rubStart = 0;
    let summoned = false;

    function clearTimers(){
      if (revealTimer) { clearTimeout(revealTimer); revealTimer = null; }
      if (successTimer) { clearTimeout(successTimer); successTimer = null; }
    }

    function hideSuccess(){
      successOverlay.classList.remove("show");
      successOverlay.setAttribute("aria-hidden","true");
    }

    function toRubMode(){
      clearTimers();
      hideSuccess();

      mode = "rub";
      body.classList.remove("mode-choose","mode-win");
      body.classList.add("mode-rub");

      centerLamp.classList.remove("pulse");
      rubbing = false;
      rubDistance = 0;
      rubStart = 0;
      summoned = false;

      rewardWrap.classList.remove("show","float");
      rewardWrap.style.opacity = 0;

      formCard.classList.remove("reveal");
      formCard.setAttribute("aria-hidden","true");
      nameField.value = "";
      phoneField.value = "";

      stopFireworks();
    }

    function toWinMode(prizeUrl){
      clearTimers();
      hideSuccess();

      mode = "win";
      body.classList.remove("mode-choose","mode-rub");
      body.classList.add("mode-win");

      // show prize immediately
      rewardImg.src = prizeUrl;
      rewardWrap.style.opacity = 1;
      rewardWrap.classList.add("show");
      setTimeout(() => rewardWrap.classList.add("float"), 700);

      // hide form first, then reveal after 1–2 seconds
      formCard.classList.remove("reveal");
      formCard.setAttribute("aria-hidden","true");

      revealTimer = setTimeout(() => {
        formCard.classList.add("reveal");
        formCard.setAttribute("aria-hidden","false");
        nameField.focus({ preventScroll: true });
      }, 1400); // ~1.4s (between 1–2 sec)

      startFireworksFromLamp();
    }

    function resetAll(){
      clearTimers();
      hideSuccess();

      mode = "choose";
      body.classList.remove("mode-rub","mode-win");
      body.classList.add("mode-choose");

      centerLamp.classList.add("pulse");
      centerLamp.classList.remove("rub-active");

      rubbing = false;
      rubDistance = 0;
      rubStart = 0;
      summoned = false;

      rewardWrap.classList.remove("show","float");
      rewardWrap.style.opacity = 0;

      formCard.classList.remove("reveal");
      formCard.setAttribute("aria-hidden","true");
      nameField.value = "";
      phoneField.value = "";

      makeDust();
      stopFireworks();
    }

    // Enter rub mode
    centerBtn.addEventListener("click", () => {
      if (mode === "choose") toRubMode();
    });

    backBtn.addEventListener("click", resetAll);

    // ---- Rub gesture ----
    function insideLamp(clientX, clientY){
      const r = centerLamp.getBoundingClientRect();
      const pad = Math.min(r.width, r.height) * 0.08;
      return clientX >= r.left+pad && clientX <= r.right-pad && clientY >= r.top+pad && clientY <= r.bottom-pad;
    }

    function getPoint(e){
      if (e.touches && e.touches[0]) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
      return { x: e.clientX, y: e.clientY };
    }

    function onDown(e){
      if (mode !== "rub" || summoned) return;
      const pt = getPoint(e);
      if (!insideLamp(pt.x, pt.y)) return;

      rubbing = true;
      centerLamp.classList.add("rub-active");
      lastX = pt.x; lastY = pt.y;
      if (!rubStart) rubStart = performance.now();
      e.preventDefault();
    }

    function onMove(e){
      if (!rubbing || mode !== "rub" || summoned) return;
      const pt = getPoint(e);
      if (!insideLamp(pt.x, pt.y)) return;

      const dx = pt.x - lastX;
      const dy = pt.y - lastY;
      const dist = Math.hypot(dx, dy);

      if (dist > 1.2) {
        rubDistance += dist;
        lastX = pt.x; lastY = pt.y;
      }

      const t = performance.now() - rubStart;

      // ~1–2 seconds + some movement
      const timeOk = t / 1100;
      const distOk = rubDistance / 860;
      const p = Math.min(1, (timeOk * 0.62) + (distOk * 0.38));

      if (t >= 880 && rubDistance >= 600 && p >= 0.985){
        summon();
      }

      e.preventDefault();
    }

    function onUp(){
      rubbing = false;
      centerLamp.classList.remove("rub-active");
    }

    window.addEventListener("pointerdown", onDown, {passive:false});
    window.addEventListener("pointermove", onMove, {passive:false});
    window.addEventListener("pointerup", onUp, {passive:true});
    window.addEventListener("pointercancel", onUp, {passive:true});

    function summon(){
      if (summoned) return;
      summoned = true;
      centerLamp.classList.remove("rub-active");

      const prizeUrl = PRIZES[Math.floor(Math.random() * PRIZES.length)];
      toWinMode(prizeUrl);
    }

    // ---- Lead form ----
    leadForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const name = nameField.value.trim();
      const phone = phoneField.value.trim();

      if (!name || !phone){
        formCard.classList.remove("shake");
        void formCard.offsetWidth;
        formCard.classList.add("shake");
        return;
      }

      // demo submit
      console.log("Lead submitted:", { name, phone });

      // full screen checkmark
      successOverlay.classList.add("show");
      successOverlay.setAttribute("aria-hidden","false");

      // optional: auto-return after a moment
      successTimer = setTimeout(() => {
        resetAll();
      }, 1600);
    });

    // tap overlay to return instantly (no text)
    successOverlay.addEventListener("click", () => resetAll());

    // ---- Fireworks ----
    let particles = [];
    let burstsActive = false;
    let rafId = null;
    let burstTimerId = null;

    function startFireworksFromLamp(){
      resizeCanvas();
      const rect = centerLamp.getBoundingClientRect();
      const origin = {
        x: rect.left + rect.width * 0.50,
        y: rect.top  + rect.height * 0.24
      };

      particles = [];
      burstsActive = true;

      const start = performance.now();
      burstTimerId = setInterval(() => {
        const now = performance.now();
        if (now - start > 1600){
          clearInterval(burstTimerId);
          burstTimerId = null;
          burstsActive = false;
          return;
        }
        spawnBurst(origin.x, origin.y);
      }, 170);

      spawnBurst(origin.x, origin.y);
      spawnBurst(origin.x, origin.y);

      if (!rafId) rafId = requestAnimationFrame(tick);
    }

    function stopFireworks(){
      burstsActive = false;
      if (burstTimerId) { clearInterval(burstTimerId); burstTimerId = null; }
      particles = [];
      if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
      ctx.clearRect(0,0,fxCanvas.clientWidth, fxCanvas.clientHeight);
    }

    function spawnBurst(x,y){
      const count = 56 + Math.floor(Math.random()*24);
      const baseHue = Math.random()*360;

      for (let i=0;i<count;i++){
        const ang = Math.random() * Math.PI * 2;
        const spd = 2.6 + Math.random() * 5.8;

        particles.push({
          x, y,
          vx: Math.cos(ang) * spd,
          vy: Math.sin(ang) * spd - (2.1 + Math.random()*1.7),
          g: 0.10 + Math.random()*0.08,
          life: 1,
          decay: 0.012 + Math.random()*0.012,
          size: 1.2 + Math.random()*2.2,
          hue: (baseHue + Math.random()*70) % 360
        });
      }
    }

    function tick(){
      rafId = requestAnimationFrame(tick);
      const w = fxCanvas.clientWidth;
      const h = fxCanvas.clientHeight;

      ctx.fillStyle = "rgba(255,255,255,0.16)";
      ctx.fillRect(0,0,w,h);

      for (let i = particles.length - 1; i >= 0; i--){
        const p = particles[i];
        p.vy += p.g;
        p.x += p.vx;
        p.y += p.vy;
        p.life -= p.decay;

        if (p.life <= 0 || p.y > h + 20 || p.x < -20 || p.x > w + 20){
          particles.splice(i,1);
          continue;
        }

        ctx.beginPath();
        ctx.fillStyle = `hsla(${p.hue}, 95%, 55%, ${Math.max(0, p.life)})`;
        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
        ctx.fill();
      }

      if (!burstsActive && particles.length === 0){
        cancelAnimationFrame(rafId);
        rafId = null;
        ctx.clearRect(0,0,fxCanvas.clientWidth, fxCanvas.clientHeight);
      }
    }

    // Start
    resetAll();
  </script>
</body>
</html>
